#!/bin/bash

function usage {

  echo "Usage: ./stratio-xd-shell [OPTION]... [SPARK_OPTIONS] "
  echo "Runs the Apache Spark shell with The Crossdata Context support"
  echo "Example: ./stratio-xd-shell --cassandra --jars myApp.jar"
  echo ""
  echo "--cassandra         Add support for Cassandra"
  echo "--mongodb           Add support for MongoDB"
  echo "--elasticsearch     Add support for ElasticSearch"
  echo ""
  echo "[SPARK_OPTIONS]"
  echo "Spark's specific options"
  echo "Run $SPARK_HOME/bin/spark-shell --help for more details."
  echo ""
  exit 1
}

export SPARK_HOME="$(pwd)"

# TODO fix the script
CROSSDATA_VERSION="$(echo $(pwd) | cut -d '-' -f 4)"

xdjars="$SPARK_HOME/lib/crossdata-core-$CROSSDATA_VERSION-jar-with-dependencies.jar"
MONGODB_LIB="$SPARK_HOME/lib/crossdata-mongodb-$CROSSDATA_VERSION-jar-with-dependencies.jar"
CASSANDRA_LIB="$SPARK_HOME/lib/crossdata-cassandra-$CROSSDATA_VERSION-jar-with-dependencies.jar"
ELASTICSEARCH_LIB="$SPARK_HOME/lib/crossdata-elasticsearch-$CROSSDATA_VERSION-jar-with-dependencies.jar"


# Keep all the arguments, then remove the XD specific ones and only keep the Spark arguments.
sparkArguments="$@"


while [[ $# > 0 ]]
do
key="$1"
case $key in
    --jars)	
    jars="$2"
    xdjars="$xdjars,$jars"
    sparkArguments=${sparkArguments/--jars $jars/}     
    shift # past argument
    ;;
    --cassandra)
	xdjars="$xdjars,$CASSANDRA_LIB"
    sparkArguments=${sparkArguments/--cassandra/}          
    ;;
    --mongodb)
    xdjars="$xdjars,$MONGODB_LIB"
    sparkArguments=${sparkArguments/--mongodb/}          
    ;;
    --elasticsearch)
    xdjars="$xdjars,$ELASTICSEARCH_LIB"
    sparkArguments=${sparkArguments/--elasticsearch/}
    ;;
    --help)
    usage
    ;;
    *)
    ;;
esac
shift # past argument or value
done

echo "$SPARK_HOME/bin/spark-shell -i $SPARK_HOME/bin/stratio-xd-init.scala --jars $xdjars $sparkArguments"

$SPARK_HOME/bin/spark-shell -i $SPARK_HOME/bin/stratio-xd-init.scala --jars $xdjars $sparkArguments
